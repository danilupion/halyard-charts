apiVersion: apps/v1
kind: Deployment
metadata:
  {{- include "common.metadata" (dict "name" (include "common.fullname" .) "root" $) | nindent 2 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "common.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: server
  template:
    metadata:
      labels:
        {{- include "common.selectorLabels" $ | nindent 8 }}
        app.kubernetes.io/component: server
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: db-migrate
          {{- include "common.image" (dict "repository" (printf "%s/%s" .Values.image.registry .Values.image.repository) "tag" .Values.image.tag "pullPolicy" .Values.image.pullPolicy "root" $) | nindent 10 }}
          command:
            - /bin/sh
            - -c
            - /entrypoint.sh db createdb && /entrypoint.sh db migrate
          env:
            # Base URL (required by Plausible config)
            {{- include "common.env" (dict "name" "BASE_URL" "value" .Values.plausible.baseUrl) | nindent 12 }}
            # Secret key base (required by Plausible config)
            {{- if .Values.plausible.existingSecret }}
            {{- include "common.envSecret" (dict "name" "SECRET_KEY_BASE" "secret" .Values.plausible.existingSecret "key" "SECRET_KEY_BASE") | nindent 12 }}
            {{- else if .Values.plausible.secretKeyBase }}
            {{- include "common.env" (dict "name" "SECRET_KEY_BASE" "value" .Values.plausible.secretKeyBase) | nindent 12 }}
            {{- end }}
            # PostgreSQL configuration
            {{- if .Values.postgresql.enabled }}
            {{- if .Values.postgresql.auth.existingSecret }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.auth.existingSecret }}
                  key: password
            {{- else }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.fullnameOverride }}
                  key: password
            {{- end }}
            - name: DATABASE_URL
              value: "postgres://{{ .Values.postgresql.auth.username }}:$(POSTGRES_PASSWORD)@{{ .Values.postgresql.fullnameOverride }}:5432/{{ .Values.postgresql.auth.database }}"
            {{- else }}
            {{- if .Values.externalPostgresql.existingSecret }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalPostgresql.existingSecret }}
                  key: {{ .Values.externalPostgresql.existingSecretKey }}
            {{- else }}
            {{- include "common.env" (dict "name" "POSTGRES_PASSWORD" "value" .Values.externalPostgresql.password) | nindent 12 }}
            {{- end }}
            - name: DATABASE_URL
              value: "postgres://{{ .Values.externalPostgresql.username }}:$(POSTGRES_PASSWORD)@{{ .Values.externalPostgresql.host }}:{{ .Values.externalPostgresql.port }}/{{ .Values.externalPostgresql.database }}"
            {{- end }}
            # ClickHouse configuration
            {{- if .Values.clickhouse.enabled }}
            {{- if .Values.clickhouse.auth.existingSecret }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.clickhouse.auth.username }}:$(CLICKHOUSE_PASSWORD)@{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouse.auth.existingSecret }}
                  key: {{ .Values.clickhouse.auth.existingSecretKey | default "password" }}
            {{- else if .Values.clickhouse.auth.password }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.clickhouse.auth.username }}:{{ .Values.clickhouse.auth.password }}@{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            {{- else }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            {{- end }}
            {{- else }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.externalClickhouse.username }}:$(CLICKHOUSE_PASSWORD)@{{ .Values.externalClickhouse.host }}:{{ .Values.externalClickhouse.port }}/{{ .Values.externalClickhouse.database }}"
            {{- if .Values.externalClickhouse.existingSecret }}
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalClickhouse.existingSecret }}
                  key: {{ .Values.externalClickhouse.existingSecretKey }}
            {{- else }}
            {{- include "common.env" (dict "name" "CLICKHOUSE_PASSWORD" "value" .Values.externalClickhouse.password) | nindent 12 }}
            {{- end }}
            {{- end }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
      containers:
        - name: plausible
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- include "common.image" (dict "repository" (printf "%s/%s" .Values.image.registry .Values.image.repository) "tag" .Values.image.tag "pullPolicy" .Values.image.pullPolicy "root" $) | nindent 10 }}
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            # Base URL (required)
            {{- include "common.env" (dict "name" "BASE_URL" "value" .Values.plausible.baseUrl) | nindent 12 }}

            # Secret key base
            {{- if .Values.plausible.existingSecret }}
            {{- include "common.envSecret" (dict "name" "SECRET_KEY_BASE" "secret" .Values.plausible.existingSecret "key" "SECRET_KEY_BASE") | nindent 12 }}
            {{- else if .Values.plausible.secretKeyBase }}
            {{- include "common.env" (dict "name" "SECRET_KEY_BASE" "value" .Values.plausible.secretKeyBase) | nindent 12 }}
            {{- end }}

            # Registration settings
            {{- include "common.env" (dict "name" "DISABLE_REGISTRATION" "value" (.Values.plausible.disableRegistration | toString)) | nindent 12 }}
            {{- if .Values.plausible.enableEmailVerification }}
            {{- include "common.env" (dict "name" "ENABLE_EMAIL_VERIFICATION" "value" "true") | nindent 12 }}
            {{- end }}

            # PostgreSQL configuration
            # Note: POSTGRES_PASSWORD must be defined BEFORE DATABASE_URL for $(VAR) substitution to work
            {{- if .Values.postgresql.enabled }}
            {{- if .Values.postgresql.auth.existingSecret }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.auth.existingSecret }}
                  key: password
            {{- else }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.fullnameOverride }}
                  key: password
            {{- end }}
            - name: DATABASE_URL
              value: "postgres://{{ .Values.postgresql.auth.username }}:$(POSTGRES_PASSWORD)@{{ .Values.postgresql.fullnameOverride }}:5432/{{ .Values.postgresql.auth.database }}"
            {{- else }}
            {{- if .Values.externalPostgresql.existingSecret }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalPostgresql.existingSecret }}
                  key: {{ .Values.externalPostgresql.existingSecretKey }}
            {{- else }}
            {{- include "common.env" (dict "name" "POSTGRES_PASSWORD" "value" .Values.externalPostgresql.password) | nindent 12 }}
            {{- end }}
            - name: DATABASE_URL
              value: "postgres://{{ .Values.externalPostgresql.username }}:$(POSTGRES_PASSWORD)@{{ .Values.externalPostgresql.host }}:{{ .Values.externalPostgresql.port }}/{{ .Values.externalPostgresql.database }}"
            {{- end }}

            # ClickHouse configuration
            {{- if .Values.clickhouse.enabled }}
            {{- if .Values.clickhouse.auth.existingSecret }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.clickhouse.auth.username }}:$(CLICKHOUSE_PASSWORD)@{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouse.auth.existingSecret }}
                  key: {{ .Values.clickhouse.auth.existingSecretKey | default "password" }}
            {{- else if .Values.clickhouse.auth.password }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.clickhouse.auth.username }}:{{ .Values.clickhouse.auth.password }}@{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            {{- else }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ include "common.fullname" . }}-clickhouse:8123/{{ .Values.clickhouse.database }}"
            {{- end }}
            {{- else }}
            - name: CLICKHOUSE_DATABASE_URL
              value: "http://{{ .Values.externalClickhouse.username }}:$(CLICKHOUSE_PASSWORD)@{{ .Values.externalClickhouse.host }}:{{ .Values.externalClickhouse.port }}/{{ .Values.externalClickhouse.database }}"
            {{- if .Values.externalClickhouse.existingSecret }}
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalClickhouse.existingSecret }}
                  key: {{ .Values.externalClickhouse.existingSecretKey }}
            {{- else }}
            {{- include "common.env" (dict "name" "CLICKHOUSE_PASSWORD" "value" .Values.externalClickhouse.password) | nindent 12 }}
            {{- end }}
            {{- end }}

            # Email configuration
            {{- if .Values.mailer.enabled }}
            {{- include "common.env" (dict "name" "MAILER_ADAPTER" "value" .Values.mailer.adapter) | nindent 12 }}
            {{- if .Values.mailer.emailFrom }}
            {{- include "common.env" (dict "name" "MAILER_EMAIL" "value" .Values.mailer.emailFrom) | nindent 12 }}
            {{- end }}
            {{- if eq .Values.mailer.adapter "Bamboo.Mua" }}
            {{- include "common.env" (dict "name" "SMTP_HOST_ADDR" "value" .Values.mailer.smtp.host) | nindent 12 }}
            {{- include "common.env" (dict "name" "SMTP_HOST_PORT" "value" (.Values.mailer.smtp.port | toString)) | nindent 12 }}
            {{- if .Values.mailer.smtp.username }}
            {{- include "common.env" (dict "name" "SMTP_USER_NAME" "value" .Values.mailer.smtp.username) | nindent 12 }}
            {{- end }}
            {{- if .Values.mailer.smtp.existingSecret }}
            {{- include "common.envSecret" (dict "name" "SMTP_USER_PWD" "secret" .Values.mailer.smtp.existingSecret "key" .Values.mailer.smtp.existingSecretKey) | nindent 12 }}
            {{- else if .Values.mailer.smtp.password }}
            {{- include "common.env" (dict "name" "SMTP_USER_PWD" "value" .Values.mailer.smtp.password) | nindent 12 }}
            {{- end }}
            {{- if .Values.mailer.smtp.sslEnabled }}
            {{- include "common.env" (dict "name" "SMTP_HOST_SSL_ENABLED" "value" "true") | nindent 12 }}
            {{- end }}
            {{- end }}
            {{- end }}

            # Geolocation
            {{- if .Values.geolocation.existingSecret }}
            {{- include "common.envSecret" (dict "name" "MAXMIND_LICENSE_KEY" "secret" .Values.geolocation.existingSecret "key" "MAXMIND_LICENSE_KEY") | nindent 12 }}
            {{- include "common.env" (dict "name" "MAXMIND_EDITION" "value" .Values.geolocation.edition) | nindent 12 }}
            {{- else if .Values.geolocation.maxmindLicenseKey }}
            {{- include "common.env" (dict "name" "MAXMIND_LICENSE_KEY" "value" .Values.geolocation.maxmindLicenseKey) | nindent 12 }}
            {{- include "common.env" (dict "name" "MAXMIND_EDITION" "value" .Values.geolocation.edition) | nindent 12 }}
            {{- end }}

            # Google integration
            {{- if .Values.google.existingSecret }}
            {{- include "common.envSecret" (dict "name" "GOOGLE_CLIENT_ID" "secret" .Values.google.existingSecret "key" "GOOGLE_CLIENT_ID") | nindent 12 }}
            {{- include "common.envSecret" (dict "name" "GOOGLE_CLIENT_SECRET" "secret" .Values.google.existingSecret "key" "GOOGLE_CLIENT_SECRET") | nindent 12 }}
            {{- else }}
            {{- if .Values.google.clientId }}
            {{- include "common.env" (dict "name" "GOOGLE_CLIENT_ID" "value" .Values.google.clientId) | nindent 12 }}
            {{- end }}
            {{- if .Values.google.clientSecret }}
            {{- include "common.env" (dict "name" "GOOGLE_CLIENT_SECRET" "value" .Values.google.clientSecret) | nindent 12 }}
            {{- end }}
            {{- end }}

            # Additional environment variables
            {{- with .Values.plausible.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with .Values.plausible.extraEnvFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
